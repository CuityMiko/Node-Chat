<!doctype html>
<html manifest="cache.manifest">
	<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<!-- Deprecated <meta http-equiv="Cache-control" content="private, max-age=0" /> -->
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="description" content="A node chat project." />
	<meta name="keywords" content="Project" />
	<meta name="author" content="Niko H. (Sehrentos)" />
	<meta name="robots" content="noindex, nofollow" />
	<link rel="shortcut icon" href="images/icon32.ico" sizes="32x32" type="image/x-icon" />
	<link rel="icon" href="images/favicon64.ico" sizes="64x64" type="image/x-icon" />
	<title>Chat</title>
	<!-- Stylesheet -->
	<link href="css/main.css" rel="stylesheet" />
	<link href="css/plugins.css" rel="stylesheet" />
	<!-- Javascript libraries -->
	<script src="js/lib/jquery.js"></script>
	<script src="js/lib/socket.io.js"></script>
	<!-- Javascripts -->
	<script src="js/plugins.js" charset="utf-8"></script>
	<script src="js/main.js" charset="utf-8"></script>
	<script>
	// Call exported node functions from nw-app.js
	if (typeof (process) === 'object') {
		if (process.mainModule.loaded) {
			var gui = require('nw.gui') || global.window.nwDispatcher.requireNwGui();
			var win = gui.Window.get();
			//win.hide();
			//win.show();
			//win.maximize();
			//win.minimize();
			//window.open();
			//window.close();
			//window.moveBy(10,30);
			//window.resizeTo(800,600);

			// Helper function for window options
			win.options = {
				full: 0,
				w: win.width, //window.innerWidth,
				h: win.height, //window.innerHeight
				x: win.x,
				y: win.y
			};

			// Resize window
			win.resize = function () {
				if (win.options.full === 0) {
					win.options.full = 1;
					win.options.w = win.width;
					win.options.h = win.height;
					win.options.x = win.x;
					win.options.y = win.y;
					win.maximize();
				} else {
					win.options.full = 0;
					window.resizeTo(win.options.w, win.options.h);
					window.moveBy(win.options.x, win.options.y);
				}
			};

			// node related functions
			var nodeExports = process.mainModule.exports;

			// Count how many times page will be loaded on this session
			nodeExports.pageload();

			// Start node server @ localhost : 3000
			var chat_server = function () {
				if (!nodeExports.server.online) {
					// jQuery prompt plugin
					$.fn.nConfirm({
						title: "Start Chat Server",
						message: "Do you want to <b>start</b> the chat server?",
						enableBackground: false,
						onSubmit: function () {
							nodeExports.server.start();
						}
					});
				}
			};
		}
	}
	// jQuery initialized
	if ("jQuery" in window) {
		// Document is loaded and ready to use
		$(function () {

			// Prevent forms submit while chat has not been initialized
			$("form").submit(function (e) {
				e.preventDefault();
				return false;
			});

			// Listen keypush events
			/* window.addEventListener('keydown', function(e) {
				if (e.keyCode == 13) console.log(e);
				return this;
			}); */

			// Ask user for server address
			var ask_server = function () {
				$.fn.nPrompt({
					title: "Set Server Address",
					message: "Please enter server <b>address</b> at the field below.",
					value: (localStorage.server ? localStorage.server : 'localhost'),
					enableBackground: true,
					onSubmit: function (server) {
						if (server === null) return;
						localStorage.server = server;

						// Continue to ask server port
						ask_port(server);
					}
				}); //end-address
			};

			var ask_port = function (server) {
				// Ask user for server port or use existing one
				$.fn.nPrompt({
					title: "Set Server Port",
					message: "Please enter server <b>port</b> at the field below.",
					value: (localStorage.port ? localStorage.port : 3000),
					enableBackground: true,
					onSubmit: function (port) {
						if (port === null) return;
						localStorage.port = port;

						// Call init...
						init_chat(server, port);
					}
				}); //end-port
			};

			// Initialize chat
			var init_chat = function (server, port) {
				// Over-write default chat settings before init
				$.extend(chat || {}, {
					method: 'ws', //https/http/ws
					address: server,
					port: port,
					channel: '',
					debugMode: true
				});

				// Initialize WebSocket
				chat.init();

				// Focus input/textarea.
				chat.setFocus();

				// Set default volume level: 0.1 - 1.0
				chat.playVolume(0.5);

				// Set main menu objects
				chat.mainMenu("click", {
					timeout: 1500,
					menu: [
						{ name: 'Nickname', link: 'chat.setName()' },
						{ name: 'Channel', link: 'chat.setChannel()' },
						{ name: 'Sound on/off', link: 'chat.playSettings()' }
					]
				});

				// Submit message event
				$("form#sendform").submit(function (e) {
					e.preventDefault();
					var whisper = $(this).parent().find("#whisper"),
						message = $(this).parent().find("#message");
					if (whisper.val().length) {
						chat.setWhisper(whisper.val(), message.val());
						message.val('');
					} else {
						chat.setSubmit(message);
					}
				})
				// Textarea keydown event
				.find("#message").keydown(function (e) {
					if (e.keyCode == 13 && !e.shiftKey) {
						e.preventDefault();
						var whisper = $(this).parent().find("#whisper"),
						message = $(this).parent().find("#message");
						if (whisper.val().length) {
							chat.setWhisper(whisper.val(), message.val());
							message.val('');
						} else {
							chat.setSubmit(message);
						}
					}
				});

			}; // end-init

			// socket.io initialized
			if ("io" in window) {
				// Check if server info already exists
				if (localStorage.server && localStorage.port) {
					// Do user wan't to use existing server detail to connect?
					$.fn.nConfirm({
						title: "Connect to existing server",
						message: "Do you want to <b>connect</b> to<br><b>" + localStorage.server + " : " + localStorage.port + "</b> ?",
						enableBackground: true,
						onSubmit: function () {
							// Call init
							init_chat(localStorage.server, localStorage.port);
						},
						onCancel: function () {
							// Ask user for server address and port
							// Will init_chat after detail is given
							ask_server();
						}
					});
				} else {
					// Ask user for server address and port
					// Will init_chat after detail is given
					ask_server();
				}

			} //end-if-socket.io
		});
	}
	</script>
	</head>
	<body>
		<div id="wrap">
			<table>
				<tr>
					<td colspan="2">
						<div id="header">
							<div id="topic">Not connected.</div>
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<div id="content">
							<ul id="messages"></ul>
						</div>
					</td>
					<td>
						<div id="users">
							<ul>
								<li class="user">&rsaquo; No users</li>
							</ul>
						</div>
					</td>
				</tr>
				<tr>
					<td colspan="2">
						<div id="footer">
							<form action="#chat" id="sendform">
								<input type="text" name="whisper" id="whisper" class="border" placeholder="Whisper" />
								<!-- <input type="text" id="message" class="border" placeholder="Write message..." autocomplete="off" autofocus required/> -->
								<textarea name="message" id="message" class="border" placeholder="Write message..." rows="1" autofocus required></textarea>
								<input type="submit" id="send" class="border" value="Send" />
							</form>
						</div>
					</td>
				</tr>
			</table>
			<div id="debug"></div>
			<div class="hidden">
				<!-- Audio source: eng.universal-soundbank.com/hits.htm -->
				<audio id="audio" controls hidden>
					<source src="sound/anvil.mp3" type="audio/mpeg">
					<source src="sound/anvil.ogg" type="audio/ogg">
					<embed src="sound/anvil.mp3">
					Your browser does not support HTML5 audio.
				</audio>
			</div>
			<!-- if you disable window frame, these buttons might come handy. -->
			<div id="windowOptions">
				<button type="button" onclick="win.minimize();" name="Minimize">_</button>
				<button type="button" onclick="win.resize();" name="Maximize">O</button>
				<button type="button" onclick="window.close();" name="Close">X</button>
			</div>
			<script>
			if (typeof (process) === 'object') {
				if (process.mainModule.loaded) {
					var fs = fs || require('fs');
					var jsonData;
					// readFile is asynchronous action
					fs.readFile('package.json', 'utf8', function (err, data) {
						if (err) throw err;
						jsonData = JSON.parse(data);
						if (jsonData.window.frame === false) {
							document.getElementById('windowOptions').style.display = "block";
						}
					});
				}
			}
			</script>
		</div>
	</body>
</html>