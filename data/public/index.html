<!DOCTYPE html>
<html lang="en">
<!-- On production: <html manifest="cache.manifest" lang="en"> -->
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<meta name="description" content="A node chat project." />
	<meta name="keywords" content="Chat" />
	<meta name="author" content="Niko H. (Sehrentos)" />
	<meta name="robots" content="noindex, nofollow" />
	<link rel="shortcut icon" href="images/icon32.ico" sizes="32x32" type="image/x-icon" />
	<link rel="icon" href="images/favicon64.ico" sizes="64x64" type="image/x-icon" />
	<title>Chat</title>
	<!-- Stylesheet -->
	<link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
	<link rel="stylesheet" href="css/main.css" />
	<link rel="stylesheet" href="css/plugins.css" />
	<!-- Javascript libraries -->
	<script src="js/lib/jquery.js"></script>
	<script src="js/lib/socket.io.js"></script>
	<!-- Javascripts -->
	<script src="js/plugins.js"></script>
	<script src="js/main.js"></script>
	<script type="text/javascript">
	// UI W3 Sidenav show/hide
	function sidenav_left_open() {
		//document.getElementsByClassName("w3-sidenav")[0].style.display = "block";
		document.querySelector("#menu-left").style.display = "block";
	}
	
	function sidenav_left_close() {
		document.querySelector("#menu-left").style.display = "none";
	}
	
	function sidenav_right_open() {
		document.querySelector("#menu-right").style.display = "block";
	}
	
	function sidenav_right_close() {
		document.querySelector("#menu-right").style.display = "none";
	}

	// Ask user for server address
	function ask_server() {
		nprompt({
			title: "Set Server Address",
			message: "Please enter server <b>address</b> at the field below.",
			input: [{
				"type": "text",
				"name": "server",
				"placeholder": "Server address",
				"value": (localStorage.server ? localStorage.server : window.location.host || 'localhost')
			},{
				"type": "text",
				"name": "port",
				"placeholder": "Server port",
				"value": (localStorage.port ? localStorage.port : 3000)
			}],
			background: true,
			onSubmit: function (data) {
				if (data.server === null && data.port === null) return;
				localStorage.server = data.server;
				localStorage.port = data.port;
				
				init_chat(data.server, data.port);
			}
		})
	}

	// Initialize chat
	function init_chat(server, port) {
		// Over-write default chat settings before init
		//$.extend(chat || {}, {
		extend(chat || {}, {
			method: 'http', //https/http/ws
			address: server,
			port: port,
			channel: '/',
			debugMode: true
		});
		// Initialize socket
		chat.init();
		// Set default volume level: 0.1 - 1.0
		chat.playVolume(0.5);
		// Focus input/textarea.
		//chat.setFocus();
	}

	/*
	* Draw canvas - Menu
	*/
	function canvasMenu(elem) {
		try {
			var canvas = document.createElement("CANVAS");
			canvas.width = 35;
			canvas.height = 35;

			var x = canvas.width,
				y = canvas.height,
				ctx = canvas.getContext("2d");

			//ctx.lineJoin="round";
			ctx.lineCap = "round";
			//Border
			ctx.lineWidth = 4 * y / 100;
			ctx.strokeRect(2 * y / 100, 2 * y / 100, x-4* y / 100, y-4* y / 100);
			// lines
			ctx.lineWidth = 8 * y / 100;
			ctx.moveTo(10 * x / 100, 25 * y / 100);
			ctx.lineTo(90 * x / 100, 25 * y / 100);
			ctx.moveTo(10 * x / 100, 50 * y / 100);
			ctx.lineTo(90 * x / 100, 50 * y / 100);
			ctx.moveTo(10 * x / 100, 75 * y / 100);
			ctx.lineTo(90 * x / 100, 75 * y / 100);
			//ctx.closePath();
			ctx.scale(0.8, 1.0);
			ctx.stroke();

			// display
			elem.appendChild(canvas);

		} catch(error) {
			console.log(error);
		}
	}
	/*
	* Draw canvas - Team
	*/
	function canvasTeam(elem) {
		try {
			var canvas = document.createElement("CANVAS");
			canvas.width = 35;
			canvas.height = 35;

			// Draw canvas - Team
			var x = canvas.width,
				y = canvas.height,
				ctx = canvas.getContext("2d");

			// head 1
			ctx.beginPath();
			ctx.strokeStyle = "#626262";
			ctx.fillStyle = "#626262";
			ctx.arc(25 * x / 100, 25 * y / 100, 20 * x / 100, 0, 2 * Math.PI);
			ctx.fill();
			// body 1
			ctx.moveTo(25 * x / 100, 25 * y / 100);
			ctx.lineTo(5 * x / 100, 80 * y / 100);
			ctx.lineTo(45 * x / 100, 80 * y / 100);
			ctx.closePath();
			ctx.fill();
			// head 2
			ctx.beginPath();
			ctx.strokeStyle = "#626262";
			ctx.fillStyle = "#626262";
			ctx.arc(75 * x / 100, 25 * y / 100, 20 * x / 100, 0, 2 * Math.PI);
			ctx.fill();
			// body 2
			ctx.moveTo(75 * x / 100, 25 * y / 100);
			ctx.lineTo(55 * x / 100, 80 * y / 100);
			ctx.lineTo(95 * x / 100, 80 * y / 100);
			ctx.closePath();
			ctx.fill();
			// Head 3
			ctx.beginPath();
			ctx.strokeStyle = "#1F1F1F";
			ctx.fillStyle = "#1F1F1F";
			ctx.arc(50 * x / 100, 50 * y / 100, 20 * x / 100, 0, 2 * Math.PI);
			ctx.fill();
			// body 3
			ctx.moveTo(50 * x / 100, 50 * y / 100);
			ctx.lineTo(30 * x / 100, 95 * y / 100);
			ctx.lineTo(70 * x / 100, 95 * y / 100);
			ctx.closePath();
			ctx.fill();
			ctx.stroke();

			// display
			elem.appendChild(canvas);

		} catch(error) {
			console.log(error);
		}
	}

	function formDataHandler() {
		var elem = document.querySelector("#chatform");
		var myObj = serialize(elem);
		
		if (myObj.whisper.length) {
			chat.setWhisper(myObj.whisper, myObj.message);
		} else if (myObj.message.length) {
			chat.submitMessage(myObj.message);
		}
		
		elem.querySelector("#chatmessage").value = "";
	}

	function formSubmit(event) {
		event.preventDefault();
		formDataHandler();
	}

	function formKeydown(event) {
		if (event.keyCode == 13 && !event.shiftKey) {
			event.preventDefault();
			document.querySelector("#chatsubmit").click();
			//formDataHandler();
		}
	}

	// Document is loaded.
	document.addEventListener("DOMContentLoaded", function(e) {
		// event.target = document
		// this = document
		var doc = e.target || event.target || this;

		// On form submit event
		doc.querySelector("#chatform").addEventListener("submit", formSubmit, false);

		// Listen keypush events
		doc.querySelector("#chatform").addEventListener("keydown", formKeydown, false);

		// socket.io initialized
		if ("io" in window) {
			// Initialize socket
			chat.init();

			// Set default volume level: 0.1 - 1.0
			var vol = localStorage.volume || 0.5;
			chat.playVolume(vol);

			// Set canvas menus
			canvasMenu( doc.querySelector("#canvasMenu") );
			canvasTeam( doc.querySelector("#canvasTeam") );
		}

	}, false); // document ready

	// Window is loaded
	window.addEventListener('load', function(e) {

		// Check if a new cache is available on page load.
		window.applicationCache.addEventListener('updateready', function(e) {
			if (window.applicationCache.status == window.applicationCache.UPDATEREADY) {
				// Browser downloaded a new app cache.
				window.location.reload();
			}
		}, false);

	}, false); // window ready

	// Before leaving page
	window.addEventListener("beforeunload", function(e) {

		var confirmationMessage = "Do you wan't to leave the page?"; // "\o/"
		e.returnValue = confirmationMessage; // Gecko, Trident, Chrome 34+
		
		return confirmationMessage; // Gecko, WebKit, Chrome <34

	}, false); // before unload
	</script>
</head>
<body>

<div id="wrap">

	<nav id="menu-left" class="w3-sidenav w3-card-2 w3-white" style="display:none">
		<a href="javascript:void(0)" onclick="sidenav_left_close()" class="w3-closenav w3-large">Close &times;</a>
		<header class="w3-container">
			<h5>Settings:</h5>
		</header>
		<div id="settings" class="w3-container">
			<a href="javascript:void(0)" onclick="chat.setNick()">Change name</a> 
			<a href="javascript:void(0)" onclick="chat.setChannel()">Change channel</a> 
			<a href="javascript:void(0)" onclick="chat.playSettings()">Sound on/off</a>
		</div>
		<!-- 
		<header class="w3-container">
			<h5>Users connected:</h5>
		</header>
		<div id="users" class="users-list w3-container"></div>
		-->
	</nav>

	<nav id="menu-right" class="w3-sidenav w3-card-2 w3-white" style="right:0; display:none">
		<a href="javascript:void(0)" onclick="sidenav_right_close()" class="w3-closenav w3-large">Close &times;</a>
		<header class="w3-container">
			<h5>Users connected:</h5>
		</header>
		<div id="users" class="users-list w3-container"></div>
	</nav>

	<header id="header" class="w3-container w3-light-grey">
		<div class="w3-container">
			<span id="canvasMenu" class="menu-canvas w3-opennav w3-padding-top" onclick="sidenav_left_open()"></span>
			<span id="canvasTeam" class="menu-canvas w3-opennav w3-padding-top w3-right" onclick="sidenav_right_open()"></span>
			<h1 id="topic">Not connected.</h1>
		</div>
	</header>

	<div id="content" class="w3-container w3-white">
		<ul id="messages"></ul>
	</div>

	<footer id="footer" class="w3-container w3-blue-grey">
		<form id="chatform" class="w3-container w3-padding-top">
			<div class="w3-row">
				<div class="w3-col m6">
					<p><textarea name="message" id="chatmessage" class="w3-input w3-border w3-white" placeholder="message..." rows="1" autofocus required></textarea></p>
				</div>
				<div class="w3-col m2">
					<p><input type="text" name="whisper" id="chatwhisper" class="w3-input w3-border w3-white" placeholder="to..." autocomplete="off" /></p>
				</div>
				<div class="w3-col m2">
					<p><input type="submit" id="chatsubmit" class="w3-input w3-btn w3-border w3-blue" value="Send" /></p>
				</div>
			</div>
			
		</form>
	</footer>

	<div id="sounds" class="hidden">
		<audio id="audio" controls hidden>
			<source src="sound/anvil.ogg" type="audio/ogg">
			<source src="sound/anvil.mp3" type="audio/mpeg">
			<embed src="sound/anvil.mp3">
			Your browser does not support HTML5 audio.
		</audio>
	</div>

</div>
<script type="text/javascript">
(function() {
	// Window resize
	window.addEventListener("resize", resizeThrottler, false);
	var resizeTimeout;
	function resizeThrottler() {
		// ignore resize events as long as an actualResizeHandler execution is in the queue
		if ( !resizeTimeout ) {
			resizeTimeout = setTimeout(function() {
				resizeTimeout = null;
				actualResizeHandler();
				// The actualResizeHandler will execute at a rate of 15fps
			}, 66);
		}
	}

	// Set content messages height (ui)
	function actualResizeHandler() {
		// handle the resize event
		var wrap = document.getElementById("wrap");
		var header = document.getElementById("header");
		var footer = document.getElementById("footer");
		var messages = document.getElementById("messages");
		var intHeight = wrap.offsetHeight - (header.offsetHeight + footer.offsetHeight);
		//messages.style.overflow = 'auto'; // In-CSS
		messages.style.height = intHeight + 'px';
		messages.scrollTop = messages.scrollHeight;
	}

	// Set content messages height (ui)
	actualResizeHandler();
}());
</script>
</body>
</html>